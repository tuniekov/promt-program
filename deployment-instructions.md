# Инструкции по развертыванию приложения

Данный документ содержит инструкции по развертыванию Node.js приложения на сервере Ubuntu 22.04 с использованием Nginx в качестве обратного прокси.

## Подготовка

Для развертывания приложения вам потребуется:

1. Сервер с чистой установкой Ubuntu 22.04
2. IP-адрес сервера
3. Имя пользователя и пароль SSH для подключения к серверу
4. API ключ для OpenRouter.ai (получите на https://openrouter.ai/keys)
5. Компьютер с Windows для запуска скриптов развертывания

## Файлы для развертывания

В данном репозитории содержатся следующие файлы для развертывания:

1. `setup-ubuntu.sh` - скрипт для настройки Ubuntu 22.04 с установкой необходимых пакетов и настроек безопасности
2. `deploy-app.bat` - скрипт для развертывания приложения на сервер с использованием SSH команд Windows

## Шаг 1: Настройка сервера Ubuntu

Первым шагом необходимо настроить сервер Ubuntu, установив все необходимые пакеты и настройки безопасности.

1. Скопируйте файл `setup-ubuntu.sh` на сервер Ubuntu:
   ```
   scp setup-ubuntu.sh username@server_ip:/tmp/
   ```

2. Подключитесь к серверу по SSH:
   ```
   ssh username@server_ip
   ```

3. Сделайте скрипт исполняемым и запустите его с правами суперпользователя:
   ```
   chmod +x /tmp/setup-ubuntu.sh
   sudo /tmp/setup-ubuntu.sh
   ```

4. Дождитесь завершения выполнения скрипта. Это может занять некоторое время, так как скрипт устанавливает и настраивает множество компонентов.

## Шаг 2: Развертывание приложения

После настройки сервера можно приступить к развертыванию приложения.

1. На компьютере с Windows откройте командную строку (cmd) или PowerShell
2. Перейдите в директорию с файлами проекта и скриптом `deploy-app.bat`
3. Запустите скрипт развертывания:
   ```
   deploy-app.bat
   ```

4. Следуйте инструкциям скрипта:
   - Введите IP-адрес сервера
   - Введите имя пользователя SSH
   - Введите пароль SSH
   - Введите API ключ для OpenRouter.ai
   - Укажите, нужно ли включить платные модели (true/false)

5. Дождитесь завершения выполнения скрипта. После успешного развертывания вы увидите сообщение с URL для доступа к приложению.

## Проверка работоспособности

После завершения развертывания вы можете проверить работоспособность приложения, открыв в браузере адрес:

```
http://server_ip
```

Где `server_ip` - IP-адрес вашего сервера.

## Устранение неполадок

Если у вас возникли проблемы при развертывании, проверьте следующее:

1. Логи Nginx:
   ```
   sudo tail -f /var/log/nginx/app_error.log
   ```

2. Логи приложения:
   ```
   sudo pm2 logs nodeapp
   ```

3. Статус сервисов:
   ```
   sudo systemctl status nginx
   sudo pm2 status
   ```

## Обновление приложения

Для обновления приложения просто запустите скрипт `deploy-app.bat` повторно, следуя тем же инструкциям.

## Безопасность

Обратите внимание, что скрипт настройки сервера (`setup-ubuntu.sh`) включает базовые настройки безопасности:

- Настройка брандмауэра (UFW)
- Установка fail2ban для защиты от брутфорс-атак
- Отключение входа по SSH для пользователя root
- Настройка автоматических обновлений безопасности

Для продакшн-окружения рекомендуется дополнительно:

1. Настроить SSL/TLS с помощью Let's Encrypt
2. Регулярно обновлять систему и пакеты
3. Настроить резервное копирование данных
4. Использовать SSH-ключи вместо паролей для аутентификации

## Примечания

- Приложение запускается на порту 3000, но доступно через Nginx на стандартном HTTP-порту 80
- Для управления процессом Node.js используется PM2, который обеспечивает автоматический перезапуск приложения при сбоях
- Приложение настроено на автозапуск при перезагрузке сервера
