# Инструкции по развертыванию приложения

Данный документ содержит инструкции по развертыванию Node.js приложения на сервере Ubuntu 22.04 с использованием Nginx в качестве обратного прокси.

## Подготовка

Для развертывания приложения вам потребуется:

1. Сервер с чистой установкой Ubuntu 22.04
2. IP-адрес сервера
3. Имя пользователя и пароль SSH для подключения к серверу
4. API ключ для OpenRouter.ai (получите на https://openrouter.ai/keys)
5. Компьютер с Windows для запуска скриптов развертывания
6. Утилиты для Windows:
   - `plink.exe` из пакета PuTTY (должна находиться в той же директории, что и скрипты)
   - `psftp.exe` из пакета PuTTY (должна находиться в той же директории, что и скрипты)
   - `tar` для архивирования файлов (обычно уже установлена в Windows 10/11)

## Файлы для развертывания

В данном репозитории содержатся следующие файлы для развертывания:

1. `setup-ubuntu.sh` - скрипт для настройки Ubuntu 22.04 с установкой необходимых пакетов и настроек безопасности
2. `deploy-app.bat` - скрипт для развертывания приложения на сервер с использованием SSH команд Windows

## Шаг 1: Настройка сервера Ubuntu

Первым шагом необходимо настроить сервер Ubuntu, установив все необходимые пакеты и настройки безопасности.

1. Скопируйте файл `setup-ubuntu.sh` на сервер Ubuntu:
   ```
   scp setup-ubuntu.sh username@server_ip:/tmp/
   ```

2. Подключитесь к серверу по SSH:
   ```
   ssh username@server_ip
   ```

3. Сделайте скрипт исполняемым и запустите его с правами суперпользователя:
   ```
   chmod +x /tmp/setup-ubuntu.sh
   sudo /tmp/setup-ubuntu.sh
   ```

4. Дождитесь завершения выполнения скрипта. Это может занять некоторое время, так как скрипт устанавливает и настраивает множество компонентов.

**Примечание**: Скрипт настроен на полностью автоматическую установку без интерактивных запросов. Он использует переменную окружения `DEBIAN_FRONTEND=noninteractive` и опции `--force-confdef` и `--force-confold` для автоматического принятия значений по умолчанию при обновлении конфигурационных файлов.

## Шаг 2: Развертывание приложения

После настройки сервера можно приступить к развертыванию приложения.

1. На компьютере с Windows откройте командную строку (cmd) или PowerShell
2. Перейдите в директорию с файлами проекта и скриптом `deploy-app.bat`
3. Запустите скрипт развертывания:
   ```
   deploy-app.bat
   ```

4. Следуйте инструкциям скрипта:
   - Введите IP-адрес сервера
   - Введите имя пользователя SSH
   - Введите пароль SSH
   - Введите API ключ для OpenRouter.ai
   - Укажите, нужно ли включить платные модели (true/false)

5. Дождитесь завершения выполнения скрипта. После успешного развертывания вы увидите сообщение с URL для доступа к приложению.

## Проверка работоспособности

После завершения развертывания вы можете проверить работоспособность приложения, открыв в браузере адрес:

```
http://server_ip
```

Где `server_ip` - IP-адрес вашего сервера.

## Устранение неполадок

Если у вас возникли проблемы при развертывании, проверьте следующее:

1. Логи Nginx:
   ```
   sudo tail -f /var/log/nginx/app_error.log
   ```

2. Логи приложения:
   ```
   sudo pm2 logs nodeapp
   ```

3. Статус сервисов:
   ```
   sudo systemctl status nginx
   sudo pm2 status
   ```

### Проблемы с кодировкой в Windows

Если при запуске скриптов в Windows вместо русских символов отображаются иероглифы или другие некорректные символы, это может быть связано с проблемой кодировки в командной строке Windows.

Решение:
1. Скрипты уже содержат команду `chcp 65001` для переключения на UTF-8 кодировку
2. Если проблема сохраняется, попробуйте вручную выполнить в командной строке:
   ```
   chcp 1251
   ```
   А затем запустить скрипт
3. Убедитесь, что используете шрифт в командной строке, поддерживающий кириллицу (например, Consolas или Lucida Console)

### Проблемы с отсутствием файлов

Скрипты проверяют наличие необходимых файлов перед их отправкой на сервер. Если вы получаете ошибку о том, что файл не найден, убедитесь, что:

1. Файл `setup-ubuntu.sh` находится в той же директории, что и скрипт `run-deployment.bat`
2. Утилиты `plink.exe` и `psftp.exe` из пакета PuTTY находятся в той же директории, что и скрипты
3. Временные файлы `app.tar.gz` и `deploy_commands.sh` успешно создаются скриптами (проверьте наличие ошибок при их создании)

Если вы получаете ошибку "The system cannot find the path specified" при копировании файлов, убедитесь, что:
1. Вы запускаете скрипты из директории, где находятся все необходимые файлы проекта
2. Скрипты используют правильные пути для копирования файлов
3. Директории src, public и файлы package.json, package-lock.json существуют в директории проекта

Если архив app.tar.gz создается пустым или директория temp_deploy пустая, убедитесь, что:
1. Структура проекта соответствует ожидаемой (директории src, public и файлы package.json, package-lock.json)
2. У вас есть права на чтение файлов проекта
3. Команды xcopy и copy работают корректно в вашей системе

Если файл .env не создается в директории temp_deploy, убедитесь, что:
1. Директория temp_deploy успешно создана
2. У вас есть права на запись в эту директорию
3. Команды перенаправления вывода (>, >>) работают корректно в вашей системе

### Проблемы с подключением по SFTP

Если вы получаете ошибки при подключении по SFTP, такие как "no hostname specified" или "invalid port number", убедитесь, что:

1. IP-адрес сервера введен корректно (без пробелов и дополнительных символов)
2. Имя пользователя и пароль введены правильно
3. Сервер доступен по SSH (попробуйте подключиться вручную с помощью PuTTY)
4. Порт SSH на сервере открыт (по умолчанию 22)

**Примечание**: Скрипты используют прямой формат подключения SFTP:
```
psftp.exe %SSH_USER%@%SERVER_IP% -pw %SSH_PASSWORD% -b psftp_commands.txt
```
Этот формат более надежен, чем использование команд `open` и `user` в файле команд.

## Обновление приложения

Для обновления приложения просто запустите скрипт `deploy-app.bat` повторно, следуя тем же инструкциям.

## Безопасность

Обратите внимание, что скрипт настройки сервера (`setup-ubuntu.sh`) включает базовые настройки безопасности:

- Настройка брандмауэра (UFW)
- Установка fail2ban для защиты от брутфорс-атак
- Отключение входа по SSH для пользователя root
- Настройка автоматических обновлений безопасности

Для продакшн-окружения рекомендуется дополнительно:

1. Настроить SSL/TLS с помощью Let's Encrypt
2. Регулярно обновлять систему и пакеты
3. Настроить резервное копирование данных
4. Использовать SSH-ключи вместо паролей для аутентификации

## Примечания

- Приложение запускается на порту 3000, но доступно через Nginx на стандартном HTTP-порту 80
- Для управления процессом Node.js используется PM2, который обеспечивает автоматический перезапуск приложения при сбоях
- Приложение настроено на автозапуск при перезагрузке сервера
